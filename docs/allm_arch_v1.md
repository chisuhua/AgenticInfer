
# ğŸ“œ ä¿®æ­£ç‰ˆï¼šAgenticDSL ä¸ C++ æ¨ç†å¼•æ“æ·±åº¦é›†æˆæ¶æ„ï¼ˆv2ï¼‰

> **ç›®æ ‡**ï¼šæ„å»ºä¸€ä¸ª **å¥‘çº¦é©±åŠ¨ã€æƒé™å®‰å…¨ã€ç¡®å®šæ€§æ‰§è¡Œã€ä¸‰å±‚æ¶æ„åˆè§„** çš„ LLM æ¨ç†ç³»ç»Ÿï¼Œå…¶ä¸­ AgenticDSL ä½œä¸º **å£°æ˜å¼æ§åˆ¶å¹³é¢**ï¼ŒC++ æ¡†æ¶ä½œä¸º **é«˜æ€§èƒ½æ‰§è¡Œå¹³é¢**ã€‚

---

## ğŸ” é—®é¢˜é€é¡¹å›åº”ä¸ä¿®æ­£

### 1ï¸âƒ£ é—®é¢˜ï¼šæœªå®ç° `/__meta__/resources` å£°æ˜å¼èµ„æºéªŒè¯æœºåˆ¶

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š
- C++ æ¡†æ¶åœ¨å¯åŠ¨æ—¶å¿…é¡»è§£æ AgenticDSL æ–‡æ¡£ä¸­çš„ `/__meta__/resources` å—ï¼›
- æ‰§è¡Œå™¨ï¼ˆAgenticDSL Runtimeï¼‰åœ¨ DAG å¯åŠ¨å‰è°ƒç”¨ C++ æ¡†æ¶çš„ `validateResources()` æ¥å£ï¼›
- è‹¥èµ„æºä¸å¯ç”¨ï¼ˆå¦‚ CUDA ä¸æ”¯æŒã€é‡åŒ–ç±»å‹ç¼ºå¤±ï¼‰ï¼Œç«‹å³è¿”å› `ERR_RESOURCE_UNAVAILABLE` å¹¶ç»ˆæ­¢ã€‚

```agentic
### AgenticDSL '/__meta__/resources'
type: resource_declare
resources:
  - type: runtime
    name: cuda_kernel
    allow_imports: []  # ä»…è¡¨ç¤ºèƒ½åŠ›å­˜åœ¨
  - type: memory
    backends: [paged_kv]
  - type: tool
    name: gguf_loader
    scope: read_only
    capabilities: [load_q4k, load_f16]
```

C++ æ¡†æ¶å®ç°ï¼š
```cpp
// C++ Resource Validator
struct ResourceValidator {
    static bool validate(const ResourceDeclaration& decl) {
        if (decl.type == "runtime" && decl.name == "cuda_kernel") {
            return CudaBackend::isAvailable();
        }
        if (decl.type == "tool" && decl.name == "gguf_loader") {
            return GGUFLoader::supportsCapabilities(decl.capabilities);
        }
        return false;
    }
};
```

> âœ… **ç¬¦åˆè§„èŒƒ 6.4 èµ„æºå£°æ˜**ï¼šå¯åŠ¨æ—¶ä¸€æ¬¡æ€§éªŒè¯ï¼Œå¤±è´¥å³ç»ˆæ­¢ã€‚

---

### 2ï¸âƒ£ é—®é¢˜ï¼šæœªä¸¥æ ¼éµå¾ª AgenticDSL çš„ä¸‰å±‚æŠ½è±¡æ¶æ„

**ä¿®æ­£æ–¹æ¡ˆ**ï¼šæ˜ç¡®åˆ’åˆ†ä¸‰å±‚ï¼Œå¹¶ç¦æ­¢è·¨å±‚è°ƒç”¨ã€‚

| å±‚çº§ | å†…å®¹ | è·¯å¾„ |
|------|------|------|
| **1. æ‰§è¡ŒåŸè¯­å±‚**ï¼ˆå¶å­ï¼‰ | AgenticDSL å†…ç½®èŠ‚ç‚¹ï¼ˆ`assign`, `tool_call`, `assert`ï¼‰ | â€” |
| **2. æ ‡å‡†åŸè¯­å±‚** | C++ æ¨¡å—å°è£…ä¸º `/lib/**` å­å›¾ï¼Œå¸¦ `signature` | `/lib/kv/paged@v1`, `/lib/kernel/cuda_q4k@v1` |
| **3. çŸ¥è¯†åº”ç”¨å±‚** | ç”¨æˆ·å®šä¹‰çš„æ¨ç†æµç¨‹ï¼ˆå¦‚ `/main/inference`ï¼‰ | `/main/**`, `/dynamic/**` |

**å…³é”®è§„åˆ™**ï¼š
- C++ æ¨¡å— **ä¸å¾—ç›´æ¥æš´éœ²ä¸ºå·¥å…·**ï¼Œå¿…é¡»é€šè¿‡ `/lib/**` å­å›¾å°è£…ï¼›
- `/lib/**` å­å›¾å¿…é¡»å£°æ˜ `signature`ï¼Œè¾“å…¥/è¾“å‡ºç» JSON Schema éªŒè¯ï¼›
- çŸ¥è¯†åº”ç”¨å±‚ï¼ˆå¦‚ `/main/inference`ï¼‰åªèƒ½è°ƒç”¨ `/lib/**`ï¼Œä¸èƒ½ç›´æ¥ `tool_call` C++ å‡½æ•°ã€‚

```agentic
### AgenticDSL '/lib/kv/paged@v1'  â† æ ‡å‡†åŸè¯­å±‚ï¼ˆåˆè§„ï¼‰
signature:
  inputs:
    - name: max_blocks type: integer required: true
  outputs:
    - name: kv_handle type: string
version: "1.0"
stability: stable

type: tool_call
tool: paged_kv_create  â† æ­¤å·¥å…·ç”±æ‰§è¡Œå™¨æ³¨å†Œï¼Œéç”¨æˆ·å¯è§
arguments: { max_blocks: "{{ $.max_blocks }}" }
output_mapping: { handle: "result.kv_handle" }
```

> âœ… **ç¬¦åˆè§„èŒƒ 2.1 å±‚é—´å¥‘çº¦è§„åˆ™**ï¼šçŸ¥è¯†åº”ç”¨å±‚ â†’ æ ‡å‡†åŸè¯­å±‚ â†’ æ‰§è¡ŒåŸè¯­å±‚ï¼Œæ— è·³è½¬ã€‚

---

### 3ï¸âƒ£ é—®é¢˜ï¼šèµ„æºå¥æŸ„ç³»ç»Ÿç¼ºä¹æƒé™éªŒè¯ç¯èŠ‚

**ä¿®æ­£æ–¹æ¡ˆ**ï¼šå¼•å…¥ **æƒé™æ„ŸçŸ¥å¥æŸ„**ï¼ˆPermission-Aware Handleï¼‰ã€‚

- C++ æ¡†æ¶ç”Ÿæˆçš„å¥æŸ„åŒ…å« **æƒé™æ ‡ç­¾**ï¼ˆå¦‚ `kv:paged:read_write:user_123`ï¼‰ï¼›
- AgenticDSL èŠ‚ç‚¹è°ƒç”¨æ—¶éœ€å£°æ˜ `permissions`ï¼›
- æ‰§è¡Œå™¨åœ¨ `tool_call` å‰æ£€æŸ¥ï¼š**èŠ‚ç‚¹æƒé™ âˆ© å¥æŸ„æƒé™ â‰  âˆ…**ã€‚

```agentic
### AgenticDSL '/self/use_kv'
type: tool_call
tool: kv_append
arguments:
  kv_handle: "{{ $.kv_handle }}"  # å€¼ä¸º "kv:paged:rw:user_123:abc123"
  tokens: [1, 2, 3]
permissions:
  - kg: temporal_fact_insert  # âŒ æƒé™ä¸åŒ¹é…ï¼
on_error: "/self/permission_denied"
```

C++ å·¥å…·æ³¨å†Œæ—¶å£°æ˜æ‰€éœ€æƒé™ï¼š
```cpp
// æ³¨å†Œå·¥å…·æ—¶ç»‘å®šæƒé™
ToolSchema paged_kv_append = {
    .name = "kv_append",
    .required_permissions = {"memory: state_write", "kg: subgraph_write"} // ç¤ºä¾‹
};
```

> âœ… **ç¬¦åˆè§„èŒƒ 7.2 æƒé™ä¸æ²™ç®±**ï¼šäº¤é›†åŸåˆ™ + æ‹’ç»ä¼˜å…ˆã€‚

---

### 4ï¸âƒ£ é—®é¢˜ï¼šCGraph å¹¶è¡Œæ‰§è¡Œå¯èƒ½ç ´å AgenticDSL çš„ç¡®å®šæ€§æ‰¿è¯º

**ä¿®æ­£æ–¹æ¡ˆ**ï¼š**ç¦ç”¨ CGraph ä½œä¸ºåº•å±‚è°ƒåº¦å™¨**ï¼Œæ”¹ç”¨ AgenticDSL åŸç”Ÿå¹¶å‘æ¨¡å‹ã€‚

- AgenticDSL çš„ `fork` / `join` æ˜¯ **å”¯ä¸€åˆæ³•å¹¶å‘åŸè¯­**ï¼›
- C++ æ¡†æ¶å†…éƒ¨å¯ä½¿ç”¨çº¿ç¨‹æ± ï¼Œä½† **å¯¹å¤–è¡¨ç°ä¸ºå•çº¿ç¨‹ç¡®å®šæ€§è¡Œä¸º**ï¼›
- æ‰€æœ‰çŠ¶æ€å˜æ›´å¿…é¡»é€šè¿‡ `context` æ˜¾å¼ä¼ é€’ï¼Œç¦æ­¢éšå¼å…±äº«å†…å­˜ã€‚

```agentic
### AgenticDSL '/self/parallel_decode'
type: fork
fork:
  branches:
    - "/lib/decode/batch1@v1"
    - "/lib/decode/batch2@v1"
join:
  wait_for: ["batch1_done", "batch2_done"]
  merge_strategy: array_concat  # æ˜ç¡®åˆå¹¶ç­–ç•¥
next: "/end"
```

C++ æ¨¡å—å®ç°ï¼š
```cpp
// decode_batch1 å­å›¾å†…éƒ¨å¯å¤šçº¿ç¨‹ï¼Œä½†è¾“å‡ºå¿…é¡» deterministic
void decodeBatch1(const Context& input, Context& output) {
    // å†…éƒ¨ä½¿ç”¨çº¿ç¨‹æ± åŠ é€Ÿè®¡ç®—
    // ä½†æœ€ç»ˆè¾“å‡ºå¿…é¡»æŒ‰ token_id æ’åºï¼Œç¡®ä¿ determinism
    std::sort(output.tokens.begin(), output.tokens.end());
}
```

> âœ… **ç¬¦åˆè§„èŒƒ 1.3 ç¡®å®šæ€§ä¼˜å…ˆ**ï¼šç¦æ­¢å¼‚æ­¥å›è°ƒï¼Œè¾“å‡ºå¯éªŒè¯ã€‚

---

### 5ï¸âƒ£ é—®é¢˜ï¼šC++ æš´éœ²æ–¹å¼åº”ä¸º `tool_call` è€Œé JSON-RPC

**è¯„ä¼°ç»“è®º**ï¼š**ç›´æ¥é€šè¿‡ `tool_call` è°ƒç”¨ C++ å‡½æ•°æ›´åˆç†**ã€‚

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦åˆè§„ |
|------|------|------|----------|
| **JSON-RPC over IPC** | è¯­è¨€æ— å…³ | åºåˆ—åŒ–å¼€é”€å¤§ã€å»¶è¿Ÿé«˜ã€ç ´å determinism | âŒ è¿åâ€œç¡®å®šæ€§ä¼˜å…ˆâ€ |
| **ç›´æ¥ `tool_call` ç»‘å®š** | é›¶æ‹·è´ã€ä½å»¶è¿Ÿã€æƒé™å¯æ§ | éœ€ ABI ç¨³å®š | âœ… ç¬¦åˆè§„èŒƒ 5.2 |

**æ­£ç¡®åšæ³•**ï¼š
- C++ æ¡†æ¶åœ¨åˆå§‹åŒ–æ—¶å‘ AgenticDSL æ‰§è¡Œå™¨ **æ³¨å†Œå·¥å…·**ï¼ˆ`registerTool(name, func_ptr)`ï¼‰ï¼›
- `tool_call` èŠ‚ç‚¹ç›´æ¥è°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆï¼Œä¼ å…¥å·²è§£æçš„ `arguments`ï¼ˆ`std::map<std::string, Value>`ï¼‰ï¼›
- è¿”å›å€¼é€šè¿‡ `output_mapping` å†™å…¥ä¸Šä¸‹æ–‡ã€‚

```cpp
// C++ å·¥å…·å‡½æ•°ç­¾å
Value paged_kv_create(const ToolArgs& args, const Permissions& perms) {
    int max_blocks = args.get<int>("max_blocks");
    auto handle = PagedKVCache::create(max_blocks);
    return Value::String(handle.toPermissionedString(perms));
}

// æ³¨å†Œ
runtime.registerTool("paged_kv_create", paged_kv_create);
```

> âœ… **ç¬¦åˆè§„èŒƒ 5.2 `tool_call` è¯­ä¹‰**ï¼šè°ƒç”¨æ³¨å†Œå·¥å…·ï¼Œå¸¦æƒé™æ£€æŸ¥ã€‚

---

## ğŸ—ï¸ æ–°æ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AgenticDSL Document                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /__meta__   â”‚  â”‚ /main/inference       â”‚  â”‚ â† çŸ¥è¯†åº”ç”¨å±‚
â”‚  â”‚ - resources â”‚  â”‚ - assign model        â”‚  â”‚
â”‚  â”‚ - entry     â”‚  â”‚ - next: /lib/...      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /lib/kv/paged@v1                        â”‚ â”‚ â† æ ‡å‡†åŸè¯­å±‚
â”‚  â”‚ signature: { inputs: [...], outputs: [...] }â”‚
â”‚  â”‚ type: tool_call                         â”‚ â”‚
â”‚  â”‚ tool: paged_kv_create                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ tool_call
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        C++ Modular Inference Engine           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ KV Cache    â”‚  â”‚ Kernel      â”‚  â”‚ Model â”‚ â”‚ â† æ‰§è¡ŒåŸè¯­å±‚ï¼ˆC++ å®ç°ï¼‰
â”‚  â”‚ (Paged, Radix)â”‚ â”‚ (CUDA, CPU) â”‚  â”‚ Loaderâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚             â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                 â”‚ Tool Registry â”‚            â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                         â”‚ registerTool()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… åˆè§„æ€§æ€»ç»“

| è§„èŒƒæ¡æ¬¾ | å®ç°æƒ…å†µ |
|---------|--------|
| **1.3 ç¡®å®šæ€§ä¼˜å…ˆ** | C++ æ¨¡å—è¾“å‡º deterministicï¼›ç¦ç”¨å¼‚æ­¥å›è°ƒ |
| **2.1 ä¸‰å±‚æ¶æ„** | ä¸¥æ ¼åˆ†å±‚ï¼Œæ— è·¨å±‚è°ƒç”¨ |
| **4.1 Context åˆå¹¶** | ä½¿ç”¨ `array_concat` / `deep_merge` ç­‰ç­–ç•¥ |
| **5.2 `tool_call`** | C++ å‡½æ•°æ³¨å†Œä¸ºå·¥å…·ï¼Œé€šè¿‡ `tool_call` è°ƒç”¨ |
| **6.4 èµ„æºå£°æ˜** | å¯åŠ¨æ—¶éªŒè¯ `/__meta__/resources` |
| **7.2 æƒé™æ¨¡å‹** | å¥æŸ„å¸¦æƒé™æ ‡ç­¾ï¼Œæ‰§è¡Œå™¨æ£€æŸ¥äº¤é›† |
| **8.1 å…¨å±€é¢„ç®—** | `max_nodes` é™åˆ¶ DAG å¤æ‚åº¦ |

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®ç°å·¥å…·æ³¨å†Œ API**ï¼š`void registerTool(std::string name, ToolFunction fn);`
2. **å¼€å‘ `/lib/**` wrapper ç”Ÿæˆå™¨**ï¼šä» C++ æ¨¡å—è‡ªåŠ¨ç”Ÿæˆå¸¦ `signature` çš„ AgenticDSL å­å›¾ï¼›
3. **é›†æˆæƒé™æ„ŸçŸ¥å¥æŸ„**ï¼š`Handle::toPermissionedString(Permissions&)`;
4. **å¯ç”¨ `/__meta__/resources` éªŒè¯**ï¼šåœ¨æ‰§è¡Œå™¨å¯åŠ¨æµç¨‹ä¸­æ’å…¥éªŒè¯æ­¥éª¤ã€‚

æ˜¯å¦éœ€è¦æˆ‘æä¾›ä¸Šè¿°ä»»ä¸€æ¨¡å—çš„è¯¦ç»†æ¥å£å®šä¹‰æˆ–ä»£ç æ¨¡æ¿ï¼Ÿ
